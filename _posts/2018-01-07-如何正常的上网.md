---
layout: post
title: "如何正常的上网"
date: 2018-01-07
excerpt: "从网络环境到网络设置，你需要知道的一切"
tags: [mac,Internet,settings]
comments: true
---


* toc
{:toc}

# 引言

我最讨厌给别人解决的一个问题就是，“我上不去网了，不知道为什么，帮我看下吧”。这个问题是如此的复杂，中间可能出问题的环节是如此的多，以至于我都是直接回答，“我也不懂”。特别是除了设置异常造成完全无法联网，还可能有些网站总是上不去。在富强民主文明和谐的社会主义 qiang 国，我们公民当然可以自由的浏览互联网上的合法内容。如果是某些极个别的网站连接总是出现问题，并且浏览器上写着您的连接已被重置的话，要么是网站充斥着违法内容，要么就是你的网络设置存在一定不恰当之处，因此从分析你的设置导致的网络环境异常开始，我希望这篇文章最后能让读者正常的使用网络，成为一个21世纪的人类。

# 网络环境

> 声明：该节内容都是指的由于个人的错误配置造成的局部网络环境出现的小规模异常，不代表任何普遍情况和官方行为。

## DNS 相关

如果错误的设置了 DNS 选项，那么您可能会遇到这小节的各种情况。

比如随便查询一下国外某知名视频网站的真实 ip。

~~~ bash
$ dig @114.114.114.114 youtube.com

; <<>> DiG 9.8.3-P1 <<>> @114.114.114.114 youtube.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3869
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	A

;; ANSWER SECTION:
youtube.com.		68	IN	A	203.98.7.65

;; Query time: 34 msec
;; SERVER: 114.114.114.114#53(114.114.114.114)
;; WHEN: Sun Jan  7 20:47:35 2018
;; MSG SIZE  rcvd: 45

~~~

嗯，看起来不错，一下就拿到了 ip。将这个 203.98.7.65 Google 一下，如果没什么意外的话，排名较高的有一个条目叫做[域名服务器缓存污染- 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93)，这个 ip 赫然在列。所以你看，很多人都会和你一样对网络设置出现错误，导致这都专门有了一个维基词条，这种国内服务器由于一些暂时的原因或你的设置给出错误答案的行为就叫做 DNS 劫持。更直接一点如下，果然是 ping 都 ping 不通。当然这属于 ip 封锁，是另一个局部网络环境异常导致的了。

~~~ bash
$ ping -c 5 203.98.7.65
PING 203.98.7.65 (203.98.7.65): 56 data bytes
Request timeout for icmp_seq 0
Request timeout for icmp_seq 1
Request timeout for icmp_seq 2
Request timeout for icmp_seq 3

--- 203.98.7.65 ping statistics ---
5 packets transmitted, 0 packets received, 100.0% packet loss
~~~

随便 whois 一下，发现这是个新西兰的ip，也许是 Google 在那边开了个化名分公司吧。

看来国内某些 DNS 服务器临时异常解析出错了，让我们用国外的 DNS 服务器再试一发。Google 自家的服务总不会不认识自家的 ip 吧。

~~~ bash
$ dig @8.8.8.8 youtube.com

; <<>> DiG 9.8.3-P1 <<>> @8.8.8.8 youtube.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12346
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	A

;; ANSWER SECTION:
youtube.com.		196	IN	A	203.98.7.65

;; Query time: 41 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sun Jan  7 21:05:59 2018
;; MSG SIZE  rcvd: 45
~~~

WTF…这返回的 ip，看起来有点眼熟啊，难道 Google 这么浓眉大眼的家伙也叛变革命了？赶紧打开 wireshark 再来一盘。竟然有三个来自 8.8.8.8 的 DNS 回复，发出请求仅过了 0.0022s ，第一个回复就杀到了，就是 dig 显示的 203.98.7.65， 几乎同时，第二个是 8.7.198.45，吓得我赶紧 Google 一下，果然是上面一个 ip 同词条的兄弟。老夫掐指一算，这时间就算所有路由不做停留，也就走个 300km 的来回，难道我大 Google 有 DNS 服务器和我同城，还是网速比光速快，老夫才疏学浅，就不枉议了。最后一个回复在发出请求后 0.35s 后到达，这些资本主义的服务，就是没有社会主义快捷。不过收到的 ip 172.217.160.110，搞不好还真是 youtube 呢（不用去 ping 了，能 ping 通才怪）。总之，这种查询外国服务器收到一些机智的抢答的现象就是 DNS 污染。

一定是 tcp 直接查询安全性更高，赶紧来一发。

~~~ bash
 dig +tcp @8.8.8.8 youtube.com
;; communications error to 8.8.8.8#53: connection reset
~~~

这就很尴尬了，超纲了啊，TCP reset 是我们第三小节才会讲到的知识点。

如果我们查询 ipv6 地址呢，说干就干。

~~~ bash
 dig @8.8.8.8 youtube.com AAAA

; <<>> DiG 9.8.3-P1 <<>> @8.8.8.8 youtube.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 57834
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	AAAA

;; ANSWER SECTION:
youtube.com.		217	IN	A	203.98.7.65

;; Query time: 43 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sun Jan  7 21:45:07 2018
;; MSG SIZE  rcvd: 45
~~~

你说你给我返回 ipv4 地址就算了，这地址还那么熟悉还热乎着呢，这抢答我给0分。打开 wireshark 再来一次，和刚才结果差不多，第三个返回的结果才是个 ipv6 地址： 2404:6800:4008:802::200e。 Google 这个地址，你可能会看到一大堆 host 的项目，这才是正确答案。而且只要你用 ipv6 网络，直接 ping 通，现阶段网络的要点就是，ipv6 的 ip 没有任何封锁，这个下小节细谈。换回国内 DNS 试一下呢。

~~~ bash
$ dig @114.114.114.114 youtube.com AAAA

; <<>> DiG 9.8.3-P1 <<>> @114.114.114.114 youtube.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2598
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	AAAA

;; ANSWER SECTION:
youtube.com.		37	IN	AAAA	2404:6800:4012::200e

;; Query time: 106 msec
;; SERVER: 114.114.114.114#53(114.114.114.114)
;; WHEN: Sun Jan  7 21:51:25 2018
;; MSG SIZE  rcvd: 57
~~~

不管你信不信这个地址是对的。。。厉害了，所以刚才都说了是暂时局部的网络问题惹。当然并不是所有 DNS 服务器都这么幸运，比如。

~~~ bash
$ dig @180.76.76.76 youtube.com AAAA

; <<>> DiG 9.8.3-P1 <<>> @180.76.76.76 youtube.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 22161
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	AAAA

;; Query time: 69 msec
;; SERVER: 180.76.76.76#53(180.76.76.76)
;; WHEN: Sun Jan  7 21:59:58 2018
;; MSG SIZE  rcvd: 29
~~~

这是什么意思，没回答，难道百度 DNS 不支持 ipv4v6 双栈么，测试一下。

~~~ bash
$ dig +short @180.76.76.76 hdtv.neu6.edu.cn AAAA
2001:da8:9000::130
~~~

这就尴尬了，您老人家是认识 ipv6 的双栈 DNS 服务器啊，这种行为既不是 DNS 污染也不是劫持，我觉得这种现象可以叫做 DNS 白痴，假装一问三不知，给 ip 是不可能给 ip 的，这辈子都不会给，假的都不告诉你。还有一些更恶劣的，像这样

~~~ bash
$ dig @223.5.5.5 youtube.com AAAA

; <<>> DiG 9.8.3-P1 <<>> @223.5.5.5 youtube.com AAAA
; (1 server found)
;; global options: +cmd
;; connection timed out; no servers could be reached
~~~

你能相信，它还可以假装自己不是一台 DNS 服务器，我的天啊，你这假动作差点把我也骗了呢，害我等你结果等了十秒，但你为什么国内的 ipv6 网站就秒回了呢，一定是刚才网络不好。

~~~ bash
$ dig +short @223.5.5.5 hdtv.neu6.edu.cn AAAA
2001:da8:9000::130
~~~

这种现象应该叫啥， DNS 装死？所以进入新时代，DNS 劫持和污染已经概括不全了，更高端的 DNS 装死和 DNS 白痴已经粉墨登场了。 不过有趣的是，以上国内知名 DNS 服务器均可正确解析 google.com 的 ipv6 地址，我也不知道这意味着啥，顺口一提。

最后我们看一下，直接请求 ipv6 地址的服务器会发生啥。试一试传说中的我国首个公共 ipv6 DNS。

~~~ bash
$ dig @240c::6666 youtube.com AAAA

; <<>> DiG 9.8.3-P1 <<>> @240c::6666 youtube.com AAAA
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 28904
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;youtube.com.			IN	AAAA

;; Query time: 79 msec
;; SERVER: 240c::6666#53(240c::6666)
;; WHEN: Sun Jan  7 22:15:31 2018
;; MSG SIZE  rcvd: 29
~~~

ANSWER 0，复习一下刚才的知识，这属于哪一类来着，没错，DNS 白痴。在 AAAA 记录查询上，我们也碰到了 DNS 劫持这位老朋友，不信你看，返回的这 ip 维基词条榜上有名。

~~~ bash
$ dig +short @240c::6666 facebook.com AAAA
200:2:f3b9:bb27::
~~~

那么国外的 DNS 走 ipv6 请求又会如何呢。

~~~ bash
$ dig +short @2001:4860:4860::8888 youtube.com AAAA
2404:6800:4008:801::200e
$ dig +short @2001:4860:4860::8888 youtube.com
172.217.160.110
~~~

bingo！效果很好，无论是请求 A 记录还是 AAAA 记录都毫无干扰，抓包一看，没有人尝试抢答。

总之，所以我说网络环境很复杂嘛，你请求同一个网站，随便换个 DNS 服务器，拿到的 ip 都可能不一样，要想正确的上网却是有点魔幻。

总结这小节的内容，DNS 出现故障的原因都找到了，可能的修复方案又有哪些呢。大体上是有 host 文件，自建 DNS 服务器，使用小众的正常 DNS 服务器，使用各种加密方案请求国外的 DNS 服务器，或者使用国外的 ipv6 地址的 DNS 服务器。相应的修复措施是下一部份的内容。不过你以为拿到正确的 ip 地址就结束了，这才刚刚开始。